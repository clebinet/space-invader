<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Space Invaders Triangles</title>
  <style>
    body { background:black; margin:0; overflow:hidden; }
    canvas { background:black; display:block; margin:0 auto; }
    #touchControls { position:fixed; bottom:20px; left:20px; z-index:100; }
    .btn {
      background:grey; color:white; padding:15px; margin:5px;
      border-radius:10px; font-size:20px; user-select:none;
      display:inline-block; text-align:center;
    }
    #devLogin {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); color:white; text-align:center; padding-top:200px;
      z-index:9999;
    }
    #devLogin input { font-size:20px; padding:10px; }
    #devLogin button { font-size:20px; padding:10px; margin-left:10px; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="touchControls">
  <div class="btn" id="leftBtn">◀</div>
  <div class="btn" id="rightBtn">▶</div>
  <div class="btn" id="shootBtn">🔥</div>
  <div class="btn" id="shopBtn">🛒</div>
  <div class="btn" id="pauseBtn">⏸</div>
  <div class="btn" id="restartBtn">🔄</div>
  <div class="btn" id="difficultyBtn">⚙️</div>
  <div class="btn" id="devBtn">🔑</div>
</div>

<!-- Login Dev -->
<div id="devLogin">
  <h2>Connexion Développeur</h2>
  <input type="password" id="devPassword" placeholder="Mot de passe">
  <button id="devSubmit">Connexion</button>
  <button id="devCancel">Annuler</button>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let playerX = canvas.width/2, playerY = canvas.height-60;
const playerSize = 15; let playerSpeed = 5;
let lives = 3, invulnerable = false, invulnTimer = 0, infiniteInvuln = false;

let bullets = [], enemies = [], score = 0;
let spaceCoins = parseInt(localStorage.getItem("spaceCoins") || "0");
let lastShot = 0, fireDelay = 300;
let shopOpen = false, pause = false, gameOver = false;
let shopMessage = "", shopMessageTimer = 0;

let keys = {};
let difficulty = "Moyen";
let enemySpawnInterval = null;
let isDev = localStorage.getItem("isDev") === "true";
let infiniteCoins = false;

// === Touches ===
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

// === Touches tactiles ===
document.getElementById("leftBtn").addEventListener("touchstart", ()=> keys["ArrowLeft"]=true);
document.getElementById("leftBtn").addEventListener("touchend", ()=> keys["ArrowLeft"]=false);
document.getElementById("rightBtn").addEventListener("touchstart", ()=> keys["ArrowRight"]=true);
document.getElementById("rightBtn").addEventListener("touchend", ()=> keys["ArrowRight"]=false);
document.getElementById("shootBtn").addEventListener("touchstart", ()=> keys[" "]=true);
document.getElementById("shootBtn").addEventListener("touchend", ()=> keys[" "]=false);
document.getElementById("shopBtn").addEventListener("click", ()=> shopOpen=!shopOpen);
document.getElementById("pauseBtn").addEventListener("click", ()=> pause=!pause);
document.getElementById("restartBtn").addEventListener("click", restartGame);
document.getElementById("difficultyBtn").addEventListener("click", ()=>{
  let choice = prompt("Choisis la difficulté :\n1. Facile\n2. Moyen\n3. Difficile");
  if(choice==="1") setDifficulty("Facile");
  if(choice==="2") setDifficulty("Moyen");
  if(choice==="3") setDifficulty("Difficile");
});

// === Dev Button ===
document.getElementById("devBtn").addEventListener("click", ()=> {
  document.getElementById("devLogin").style.display="block";
});

// === Dev Login ===
document.getElementById("devSubmit").addEventListener("click", ()=> {
  let pwd = document.getElementById("devPassword").value;
  if(pwd==="minaminxrouge%DEV08"){
    isDev = true;
    localStorage.setItem("isDev", "true");
    alert("Connecté en mode développeur !");
    document.getElementById("devLogin").style.display="none";
    document.getElementById("devPassword").value = "";
  } else {
    alert("Mot de passe incorrect");
  }
});

// === Dev Cancel ===
document.getElementById("devCancel").addEventListener("click", () => {
  document.getElementById("devLogin").style.display = "none";
  document.getElementById("devPassword").value = "";
});

// === Dev Login click outside to close ===
document.getElementById("devLogin").addEventListener("click", e => {
  if(e.target === document.getElementById("devLogin")){
    document.getElementById("devLogin").style.display = "none";
    document.getElementById("devPassword").value = "";
  }
});

// === Dev Menu ===
function devMenu(){
  let choice = prompt("Menu Dev:\n1. +1000 SC\n2. +10 vies\n3. Reset score\n4. Déconnexion\n5. SpaceCoins infinis ON/OFF");
  if(choice==="1"){ spaceCoins += 1000; saveSpaceCoins(); }
  if(choice==="2"){ lives += 10; }
  if(choice==="3"){ score = 0; }
  if(choice==="4"){ isDev=false; localStorage.removeItem("isDev"); alert("Déconnecté du mode dev."); }
  if(choice==="5"){ infiniteCoins = !infiniteCoins; alert("SpaceCoins infinis "+(infiniteCoins?"activés":"désactivés")); }
}

// === Difficultés ===
function setDifficulty(level){
  difficulty = level;
  if(enemySpawnInterval) clearInterval(enemySpawnInterval);
  let rate = 100;
  if(level==="Facile") rate = 250;
  if(level==="Moyen") rate = 100;
  if(level==="Difficile") rate = 35;
  enemySpawnInterval = setInterval(()=> {
    if(!shopOpen && !pause && !gameOver){
      enemies.push({ x: Math.random()*canvas.width, y:0, speed:2+Math.random()*3, special:false });
    }
  },rate);
}
setDifficulty("Moyen");

function restartGame(){
  playerX = canvas.width/2; playerY = canvas.height-60;
  lives = 3; bullets = []; enemies = [];
  score = 0; invulnerable = false; invulnTimer = 0; gameOver = false;
}

function drawPlayer(){
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.moveTo(playerX, playerY-playerSize);
  ctx.lineTo(playerX-playerSize, playerY+playerSize);
  ctx.lineTo(playerX+playerSize, playerY+playerSize);
  ctx.closePath();
  ctx.fill();
}

function drawEnemy(e){
  ctx.fillStyle = e.special ? "gold" : "red";
  ctx.beginPath();
  ctx.moveTo(e.x, e.y-15);
  ctx.lineTo(e.x-15, e.y+15);
  ctx.lineTo(e.x+15, e.y+15);
  ctx.closePath();
  ctx.fill();
}

function drawBullet(b){
  ctx.fillStyle="lime";
  ctx.beginPath();
  ctx.arc(b.x,b.y,5,0,Math.PI*2);
  ctx.fill();
}

function drawText(t,x,y,s=30,c="white"){
  ctx.fillStyle=c; ctx.font=s+"px Arial"; ctx.fillText(t,x,y);
}

function update(){
  if(pause || gameOver){ drawUI(); return; }
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(keys["ArrowLeft"] && playerX-playerSize>0) playerX-=playerSpeed;
  if(keys["ArrowRight"] && playerX+playerSize<canvas.width) playerX+=playerSpeed;
  if(keys[" "] && Date.now()-lastShot>fireDelay){
    bullets.push({x:playerX,y:playerY-playerSize});
    lastShot=Date.now();
  }

  bullets.forEach(b=> b.y-=7);
  bullets = bullets.filter(b=> b.y>0);

  enemies.forEach(e=> e.y+=e.speed);
  enemies = enemies.filter(e=> e.y<canvas.height);

  bullets.forEach((b,bi)=>{
    enemies.forEach((e,ei)=>{
      if(Math.abs(b.x-e.x)<20 && Math.abs(b.y-e.y)<20){
        enemies.splice(ei,1); bullets.splice(bi,1);
        score+=10;
        spaceCoins += e.special ? 2 : 1;
        saveSpaceCoins();
      }
    });
  });

  enemies.forEach((e,ei)=>{
    if(Math.abs(playerX-e.x)<20 && Math.abs(playerY-e.y)<20){
      if(!invulnerable && !infiniteInvuln){
        lives--; invulnerable=true; invulnTimer=Date.now();
      }
      enemies.splice(ei,1);
    }
  });

  if(invulnerable && Date.now()-invulnTimer>2000) invulnerable=false;
  if(lives<=0) gameOver=true;

  drawPlayer();
  enemies.forEach(drawEnemy);
  bullets.forEach(drawBullet);

  drawText("Score: "+score,10,30);
  drawText("SpaceCoins: "+(infiniteCoins?"∞":spaceCoins),10,60);
  drawText("Vies: "+lives,10,90);
  drawText("Difficulté: "+difficulty,10,120);

  if(isDev){
    drawText("[DEV MODE] Clique sur 🔑 pour options",canvas.width-400,30,20,"yellow");
  }

  drawUI();
}

function drawUI(){
  if(shopOpen){
    ctx.fillStyle="purple"; ctx.fillRect(100,100,600,400);
    drawText("=== SHOP SPACECOINS ===",200,150,30);
    drawText("1) Speed x2 (10000 SC)",200,220,25);
    drawText("2) Invulnérabilité 1min (20000 SC)",200,260,25);
    drawText("3) Mitraillette 1min (15000 SC)",200,300,25);
    drawText("Tes SC: "+(infiniteCoins?"∞":spaceCoins),200,340,25);
    if(shopMessage && Date.now()<shopMessageTimer){
      drawText(shopMessage,200,380,25,"red");
    }
  }
  if(pause){
    drawText("=== PAUSE ===",canvas.width/2-100,canvas.height/2,40,"yellow");
  }
  if(gameOver){
    drawText("=== GAME OVER ===",canvas.width/2-120,canvas.height/2-20,40,"red");
    drawText("Appuie sur 🔄 pour recommencer",canvas.width/2-180,canvas.height/2+40,25,"white");
  }
}

setInterval(update,1000/60);

canvas.addEventListener("click",e=>{
  if(shopOpen){
    const mx=e.offsetX,my=e.offsetY;
    if(my>200 && my<230){ if(spaceCoins>=10000 || infiniteCoins){ if(!infiniteCoins){ spaceCoins-=10000; saveSpaceCoins(); } playerSpeed*=2; shopMessage="Vitesse augmentée !"; shopMessageTimer=Date.now()+2000;} else { shopMessage="Pas assez de SC !"; shopMessageTimer=Date.now()+2000; }}
    if(my>240 && my<270){ if(spaceCoins>=20000 || infiniteCoins){ if(!infiniteCoins){ spaceCoins-=20000; saveSpaceCoins(); } invulnerable=true; invulnTimer=Date.now(); shopMessage="Invulnérabilité activée !"; shopMessageTimer=Date.now()+2000; setTimeout(()=> invulnerable=false,60000);} else { shopMessage="Pas assez de SC !"; shopMessageTimer=Date.now()+2000; }}
    if(my>280 && my<310){ if(spaceCoins>=15000 || infiniteCoins){ if(!infiniteCoins){ spaceCoins-=15000; saveSpaceCoins(); } fireDelay=100; shopMessage="Mitraillette activée !"; shopMessageTimer=Date.now()+2000; setTimeout(()=>fireDelay=300,60000);} else { shopMessage="Pas assez de SC !"; shopMessageTimer=Date.now()+2000; }}
  }
});

// Shortcut dev menu
window.addEventListener("keydown", e=>{
  if(isDev && e.key==="F10") devMenu();
});

// Save SpaceCoins
function saveSpaceCoins(){ localStorage.setItem("spaceCoins", spaceCoins); }
</script>
</body>
</html>
